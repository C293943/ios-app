<!DOCTYPE html>
<html lang="zh-CN">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Live2D Viewer</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            width: 100vw;
            height: 100vh;
            overflow: hidden;
            background: transparent;
        }

        #live2d-canvas {
            width: 100%;
            height: 100%;
            display: block;
        }

        #loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #333;
            font-family: Arial, sans-serif;
            text-align: center;
            pointer-events: none;
        }
    </style>

    <script src="https://cubism.live2d.com/sdk-web/cubismcore/live2dcubismcore.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/pixi.js@7.x/dist/pixi.min.js"></script>
</head>

<body>
    <canvas id="live2d-canvas"></canvas>
    <div id="loading">加载中...</div>

    <script type="module">
        import { Live2DModel } from 'https://cdn.jsdelivr.net/npm/pixi-live2d-display@0.4.0/dist/cubism4.min.mjs';

        window.PIXI.live2d = { Live2DModel };

        console.log("PIXI version:", PIXI.VERSION);
        console.log("Live2DModel:", Live2DModel);

        // 1. 初始化 Pixi 应用
        const app = new PIXI.Application({
            view: document.getElementById('live2d-canvas'),
            autoStart: true,
            backgroundAlpha: 0,
            resizeTo: window,
            resolution: window.devicePixelRatio || 1,
            autoDensity: true
        });

        // 2. 从 URL 参数获取模型路径
        let currentModel = null;
        const urlParams = new URLSearchParams(window.location.search);
        let defaultModelPath = urlParams.get('model') || '9999.model3.json';

        // 3. 加载函数
        async function loadModel(path) {
            try {
                document.getElementById('loading').style.display = 'block';
                console.log("开始加载模型: " + path);

                // 如果有旧模型，先销毁
                if (currentModel) {
                    app.stage.removeChild(currentModel);
                    currentModel.destroy();
                }

                // 核心加载逻辑
                currentModel = await Live2DModel.from(path);

                // 缩放逻辑：让模型占据屏幕高度的 80%
                const scale = (app.screen.height * 0.8) / currentModel.height;
                currentModel.scale.set(scale);

                // 居中
                currentModel.anchor.set(0.5, 0.5); // 设置锚点为中心
                currentModel.x = app.screen.width / 2;
                currentModel.y = app.screen.height / 2 + (currentModel.height * 0.1);

                // 启用交互
                currentModel.interactive = true;
                currentModel.on('pointertap', () => {
                    // 随机播放动作
                    currentModel.motion('tap_body');
                    console.log("点击了模型");
                });

                app.stage.addChild(currentModel);
                document.getElementById('loading').style.display = 'none';
                console.log("模型加载成功!");

            } catch (error) {
                document.getElementById('loading').innerText = "加载失败: " + error.message;
                console.error("Error:", error);
            }
        }

        // 启动
        window.addEventListener('DOMContentLoaded', () => {
            loadModel(defaultModelPath);
        });
    </script>
</body>

</html>